{% extends "base.html" %}

{% block content %}
<style>
    .map-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .map-card { background: #2a2a2a; border: 2px solid #444; border-radius: 8px; overflow: hidden; position: relative; padding: 0; width: 100%; }
    .map-image { width: 100%; height: 100px; object-fit: cover; display: block; }
    .map-name { padding: 5px; text-align: center; font-weight: bold; color: white; background: rgba(0,0,0,0.8); position: absolute; bottom: 0; width: 100%; font-size: 0.9rem; }
    .chat-container { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-top: 30px; display: flex; flex-direction: column; height: 400px; }
    .map-select { background: #333; color: white; border: 1px solid #555; padding: 8px; width: 100%; margin-bottom: 10px; border-radius: 4px; }
</style>

<div class="container" style="max-width: 1000px;">
    
    <div class="card" style="text-align: center; margin-bottom: 20px;">
        <h2>{{ match.team_a }} <span style="color:#aaa">VS</span> {{ match.team_b }}</h2>
        <div style="margin-top: 10px; font-weight: bold; color: #9c27b0;" id="statusDisplay">
            STATUS: {{ match.state|upper|replace('_', ' ') }}
        </div>
    </div>

    {% if (current_user.is_admin or current_user.is_mod) and match.state == 'waiting_for_ready' %}
    <div class="card" style="border-left: 5px solid #2196f3;">
        <h3 style="color: #2196f3;">üó∫Ô∏è Admin: Karten festlegen</h3>
        <form method="POST">
            <input type="hidden" name="set_maps" value="true">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label>Karte 1</label>
                    <select name="map_1" class="map-select">
                        {% for map in all_maps %}<option value="{{ map.name }}">{{ map.name }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label>Karte 2</label>
                    <select name="map_2" class="map-select">
                        {% for map in all_maps %}<option value="{{ map.name }}">{{ map.name }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label>Karte 3</label>
                    <select name="map_3" class="map-select">
                        {% for map in all_maps %}<option value="{{ map.name }}">{{ map.name }}</option>{% endfor %}
                    </select>
                </div>
            </div>
            <button class="btn" style="width: 100%; background: #2196f3; margin-top: 10px;">Karten best√§tigen & Code anfordern</button>
        </form>
    </div>
    {% endif %}

    {% if picked %}
    <div class="card" style="margin-bottom: 20px;">
        <h4>Zu spielende Karten:</h4>
        <div style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;">
            {% for m_name in picked %}
                {% set map_obj = all_maps | selectattr('name', 'equalto', m_name) | first %}
                <div style="min-width: 140px; text-align: center; background: #222; border: 1px solid #444; border-radius: 4px; overflow: hidden;">
                    {% if map_obj %}<img src="{{ url_for('static', filename='map_images/' + map_obj.image_file) }}" style="width: 100%; height: 70px; object-fit: cover;">{% endif %}
                    <div style="padding: 5px; font-weight: bold; font-size: 0.9rem;">{{ loop.index }}. {{ m_name }}</div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if match.state in ['waiting_for_code', 'in_progress', 'finished'] %}
    <div class="card" style="text-align: center; border: 2px solid #ff9800;">
        <h3>üîë LOBBY CODE</h3>
        <div id="lobbyCodeDisplay" style="font-size: 2.5rem; letter-spacing: 5px; font-weight: bold; color: #ff9800; margin: 20px 0;">{% if match.lobby_code %}{{ match.lobby_code }}{% else %}Warten auf Admin...{% endif %}</div>
        
        {% if current_user.is_admin or current_user.is_mod %}
            <form method="POST" style="margin-top: 10px;">
                <input type="text" name="lobby_code" placeholder="Code eingeben" value="{{ match.lobby_code or '' }}" style="padding: 10px;">
                <button name="set_lobby_code" class="btn-small">Senden & Starten</button>
            </form>
        {% endif %}
    </div>
    {% endif %}

    {% if (current_user.is_admin or current_user.is_mod) and match.state in ['in_progress', 'finished'] %}
    <div class="card" style="border-left: 5px solid #f44336; margin-top: 20px;">
        <h3 style="color: #f44336;">üëÆ Admin/Mod Panel: Ergebnisse</h3>
        <form method="POST">
            <input type="hidden" name="submit_scores" value="true">
            <table style="width: 100%; margin-bottom: 20px;">
                <tr><th style="text-align: left;">Map</th><th>{{ match.team_a }}</th><th>{{ match.team_b }}</th></tr>
                {% for i in range(3) %}
                <tr>
                    <td style="padding: 5px;">Map {{ i+1 }}: <strong>{{ picked[i] if picked|length > i else '' }}</strong></td>
                    <td style="text-align: center;"><input type="number" name="score_a_{{i}}" style="width: 50px;" value="{{ match.get_scores_a()[i] if match.state=='finished' and match.get_scores_a()|length > i else 0 }}"></td>
                    <td style="text-align: center;"><input type="number" name="score_b_{{i}}" style="width: 50px;" value="{{ match.get_scores_b()[i] if match.state=='finished' and match.get_scores_b()|length > i else 0 }}"></td>
                </tr>
                {% endfor %}
            </table>
            <button class="btn" style="background: #f44336; width: 100%;">Ergebnisse Speichern & Beenden</button>
        </form>
    </div>
    {% endif %}

    <div class="chat-container">
        <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
        <div style="display: flex; padding: 10px; border-top: 1px solid #333;">
            <input type="text" id="msgInput" style="flex: 1; padding: 10px; background: #222; border: none; color: white;" placeholder="Nachricht...">
            <button onclick="sendMsg()" class="btn-small">Senden</button>
        </div>
    </div>
</div>

<script>
    const matchId = {{ match.id }};
    const chatBox = document.getElementById('chatBox');
    const lobbyDisplay = document.getElementById('lobbyCodeDisplay');
    const statusDisplay = document.getElementById('statusDisplay');

    async function updateState() {
        try {
            const res = await fetch(`/api/cup_match/${matchId}/state`);
            const data = await res.json();
            statusDisplay.innerText = "STATUS: " + data.state.toUpperCase().replace('_', ' ');
            if (lobbyDisplay) lobbyDisplay.innerText = data.lobby_code ? data.lobby_code : "Warten auf Admin...";
            
            // Auto-Reload bei Statuswechsel f√ºr User, damit neue Maps sichtbar werden
            if (data.state === 'waiting_for_code' && !document.getElementById('lobbySection')) {
                window.location.reload();
            }
        } catch (e) { }
    }

    async function sendMsg() {
        const txt = document.getElementById('msgInput').value;
        if(!txt) return;
        await fetch(`/api/cup_match/${matchId}/chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: txt}) });
        document.getElementById('msgInput').value = ''; loadChat();
    }

    async function loadChat() {
        try {
            const res = await fetch(`/api/cup_match/${matchId}/chat`);
            const data = await res.json();
            chatBox.innerHTML = data.map(m => {
                let badge = m.is_admin ? 'üõ°Ô∏è ' : (m.is_mod ? 'üõ°Ô∏è ' : '');
                let color = m.is_admin ? '#e65100' : (m.is_mod ? '#00bcd4' : '#333');
                return `<div style="margin-bottom: 5px; text-align: ${m.is_me ? 'right':'left'}"><span style="font-size: 0.7em; color: #888;">${badge}${m.user}</span><br><span style="background: ${m.is_me ? '#1976d2' : color}; padding: 5px 10px; border-radius: 4px; display: inline-block; color: white;">${m.text}</span></div>`;
            }).join('');
        } catch(e) {}
    }

    setInterval(() => { updateState(); loadChat(); }, 2000);
    updateState(); loadChat();
</script>
{% endblock %}