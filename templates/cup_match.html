{% extends "base.html" %}

{% block content %}
<style>
    /* ... (Grid Styles) ... */
    .map-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .map-card { background: #2a2a2a; border: 2px solid #444; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; transition: transform 0.2s, border-color 0.2s; padding: 0; width: 100%; }
    .map-card:hover:not(:disabled) { transform: scale(1.05); border-color: #fff; }
    .map-image { width: 100%; height: 100px; object-fit: cover; display: block; }
    .map-name { padding: 5px; text-align: center; font-weight: bold; color: white; background: rgba(0,0,0,0.8); position: absolute; bottom: 0; width: 100%; font-size: 0.9rem; }
    
    .is-banned { filter: grayscale(100%); border-color: #5a1a1a; cursor: not-allowed; opacity: 0.6; }
    .banned-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10; display: none; }
    .banned-text { color: #ff4444; border: 3px solid #ff4444; padding: 5px 15px; font-weight: 900; transform: rotate(-15deg); font-size: 1.2rem; }
    .is-banned .banned-overlay { display: flex; }

    .is-picked { border-color: #2e7d32; box-shadow: 0 0 10px #2e7d32; cursor: not-allowed; }
    .picked-badge { position: absolute; top: 5px; right: 5px; background: #2e7d32; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; display: none; }
    .is-picked .picked-badge { display: block; }

    .chat-container { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-top: 30px; display: flex; flex-direction: column; height: 400px; }
</style>

<div class="container" style="max-width: 1000px;">
    
    <div class="card" style="margin-bottom: 20px; text-align: center; padding: 25px; border-left: 8px solid #fbc02d;" id="statusCard">
        <h2 style="margin: 0;" id="statusHeadline">Lade Status...</h2>
    </div>

    <div id="votingSection">
        <div class="map-grid">
            {% for map in all_maps %}
                <button type="button" 
                        onclick="sendMapPick('{{ map.name }}')" 
                        id="btn-map-{{ map.name|replace(' ', '-') }}"
                        class="map-card" value="{{ map.name }}">
                    
                    <img src="{{ url_for('static', filename='map_images/' + map.image_file) }}" class="map-image">
                    <div class="map-name">{{ map.name }}</div>

                    <div class="banned-overlay"><div class="banned-text">BANNED</div></div>
                    <div class="picked-badge">PICKED</div>
                </button>
            {% endfor %}
        </div>
        <div id="waitMessage" style="text-align: center; color: #aaa; margin-top: 10px; display: none;">
            ‚è≥ Gegner w√§hlt...
        </div>
    </div>

    <div id="scoringSection" class="card" style="display: none;">
        <div id="lobbySection" style="text-align: center; border: 2px solid #ff9800; margin-bottom: 20px; padding: 15px;">
            <h3>üîë LOBBY CODE</h3>
            <div id="lobbyCodeDisplay" style="font-size: 2.5rem; letter-spacing: 5px; font-weight: bold; color: #ff9800; margin: 10px 0;">...</div>
            
            {% if current_user.is_admin or current_user.is_mod %}
                <div style="margin-top: 10px;">
                    <input type="text" id="lobbyInput" placeholder="Code eingeben" style="padding: 10px;">
                    <button onclick="sendLobbyCode()" class="btn-small">Senden</button>
                </div>
            {% endif %}
        </div>

        <h3>Ergebnisse eintragen</h3>
        <form method="POST">
            <input type="hidden" name="submit_scores" value="true">
            <table style="width:100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead><tr style="border-bottom: 1px solid #555;"><th>Map</th><th>{{ match.team_a }}</th><th>{{ match.team_b }}</th></tr></thead>
                <tbody id="scoreTableBody">
                    {% for i in range(1, 6) %}
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding:10px;">
                            <small>Runde {{ i }}</small><br>
                            <strong class="map-slot-{{ i-1 }}"></strong>
                        </td>
                        <td style="text-align:center;"><input type="number" name="score_a_{{ i }}" min="0" style="width:50px; text-align:center;" value="0"></td>
                        <td style="text-align:center;"><input type="number" name="score_b_{{ i }}" min="0" style="width:50px; text-align:center;" value="0"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn" style="width:100%; background:#d32f2f;">Ergebnisse Senden üì§</button>
        </form>
    </div>

    <div class="chat-container">
        <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
        <div style="display: flex; padding: 10px; border-top: 1px solid #333;">
            <input type="text" id="msgInput" style="flex: 1; padding: 10px; background: #222; border: none; color: white;" placeholder="Nachricht...">
            <button onclick="sendMsg()" class="btn-small">Senden</button>
        </div>
    </div>

</div>

<script>
    const matchId = {{ match.id }};
    const currentUser = "{{ current_user.username }}";
    // is_admin/is_mod pr√ºfen (Python Bool zu JS Bool)
    const isAdmin = {{ 'true' if current_user.is_admin or current_user.is_mod else 'false' }};
    
    const statusHeadline = document.getElementById('statusHeadline');
    const statusCard = document.getElementById('statusCard');
    const votingSec = document.getElementById('votingSection');
    const scoringSec = document.getElementById('scoringSection');
    const waitMsg = document.getElementById('waitMessage');
    const lobbyDisplay = document.getElementById('lobbyCodeDisplay');
    const chatBox = document.getElementById('chatBox');

    // -- MAP PICK FUNKTION (AJAX) --
    async function sendMapPick(mapName) {
        const formData = new FormData();
        formData.append('selected_map', mapName);
        
        // Sende an die normale URL, ignoriere den Redirect, updateState regelt die UI
        try {
            await fetch(`/match/${matchId}`, { method: 'POST', body: formData });
            updateState(); // Sofort update triggern
        } catch(e) { console.error(e); }
    }

    // -- LOBBY CODE FUNKTION (AJAX) --
    async function sendLobbyCode() {
        const code = document.getElementById('lobbyInput').value;
        if(!code) return;
        
        const formData = new FormData();
        formData.append('lobby_code', code);
        
        try {
            await fetch(`/match/${matchId}`, { method: 'POST', body: formData });
            document.getElementById('lobbyInput').value = '';
            updateState();
        } catch(e) { console.error(e); }
    }

    // -- STATE UPDATE --
    async function updateState() {
        try {
            const res = await fetch(`/api/match/${matchId}/state`);
            const data = await res.json();
            
            // HEADER & SECTIONS
            let text = "";
            let color = "#fbc02d";
            const state = data.state;

            // Voting Section nur anzeigen wenn Bann/Pick Phase
            const isVoting = state.includes('ban') || state.includes('pick');
            votingSec.style.display = isVoting ? 'block' : 'none';
            
            // Scoring nur wenn Phase vorbei
            const isScoring = (state === 'scoring_phase' || state === 'finished');
            scoringSec.style.display = isScoring ? 'block' : 'none';

            if (state.includes('ban')) {
                text = `üö´ BANN: ${data.active_team}`;
                color = "#d32f2f";
            } else if (state.includes('pick')) {
                text = `‚úÖ PICK: ${data.active_team}`;
                color = "#1976d2";
            } else if (isScoring) {
                text = (state === 'finished') ? "üèÅ Match Beendet" : "üìù Ergebnisse eintragen";
                color = (state === 'finished') ? "#4caf50" : "#ff9800";
            }

            statusHeadline.innerText = text;
            statusCard.style.borderLeftColor = color;

            // MAP GRID UPDATE (Buttons sperren/f√§rben)
            if (isVoting) {
                const amIActive = (data.active_team === currentUser) || isAdmin;
                waitMsg.style.display = amIActive ? 'none' : 'block';

                const buttons = document.querySelectorAll('#votingSection button');
                buttons.forEach(btn => {
                    const mapName = btn.value;
                    const isBanned = data.banned.includes(mapName);
                    const isPicked = data.picked.includes(mapName);

                    btn.classList.remove('is-banned', 'is-picked');
                    if (isBanned) btn.classList.add('is-banned');
                    if (isPicked) btn.classList.add('is-picked');
                    
                    // Button sperren wenn Karte weg ist ODER ich nicht dran bin
                    btn.disabled = isBanned || isPicked || !amIActive;
                });
            }

            // SCORE TABLE MAP NAMES
            if (data.picked.length > 0) {
                data.picked.forEach((mapName, index) => {
                    const slot = document.querySelector(`.map-slot-${index}`);
                    if(slot) slot.innerText = mapName;
                });
            }

            // LOBBY CODE
            if (lobbyDisplay) lobbyDisplay.innerText = data.lobby_code ? data.lobby_code : "Warten auf Admin...";

        } catch (e) { }
    }

    // -- CHAT --
    async function sendMsg() {
        const txt = document.getElementById('msgInput').value;
        if(!txt) return;
        await fetch(`/api/match/${matchId}/chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: txt}) });
        document.getElementById('msgInput').value = ''; loadChat();
    }

    async function loadChat() {
        try {
            const res = await fetch(`/api/match/${matchId}/chat`);
            const data = await res.json();
            
            // Nur updaten wenn n√∂tig (einfacher Check: L√§nge) oder immer ersetzen und scrollen
            const oldHtml = chatBox.innerHTML;
            const newHtml = data.map(m => {
                let badge = m.is_admin ? 'üõ°Ô∏è ' : (m.is_mod ? 'üõ°Ô∏è ' : '');
                let color = m.is_admin ? '#e65100' : (m.is_mod ? '#00bcd4' : '#333');
                return `<div style="margin-bottom: 5px; text-align: ${m.is_me ? 'right':'left'}"><span style="font-size: 0.7em; color: #888;">${badge}${m.user}</span><br><span style="background: ${m.is_me ? '#1976d2' : color}; padding: 5px 10px; border-radius: 4px; display: inline-block; color: white;">${m.text}</span></div>`;
            }).join('');

            if (oldHtml !== newHtml) {
                chatBox.innerHTML = newHtml;
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll nach unten
            }
        } catch(e) {}
    }

    // Init & Interval
    setInterval(() => { updateState(); loadChat(); }, 2000);
    updateState(); loadChat();
</script>
{% endblock %}