# --- USER & CLAN MANAGER (users.html) ---

@app.route('/users')
@login_required
def users_manager():
    if not current_user.is_admin: return redirect(url_for('dashboard'))
    
    # Wir holen alle Clans und alle User, die KEINEN Clan haben
    clans = Clan.query.all()
    users_no_clan = User.query.filter_by(clan_id=None, is_admin=False).all()
    
    # WICHTIG: Hier laden wir jetzt 'users.html' statt 'clans_teams.html'
    return render_template('users.html', clans=clans, users_no_clan=users_no_clan)

@app.route('/create_user', methods=['POST'])
@login_required
def create_user():
    if not current_user.is_admin: return redirect(url_for('dashboard'))
    
    name = request.form.get('username')
    clan_id = request.form.get('clan_id') # <--- NEU: Clan ID aus Formular holen

    if not User.query.filter_by(username=name).first():
        token = str(random.randint(10000, 99999))
        new_user = User(username=name, token=token)
        
        # Wenn ein Clan ausgewählt wurde, zuweisen
        if clan_id:
            new_user.clan_id = int(clan_id)
            
        db.session.add(new_user)
        db.session.commit()
        flash(f'Team "{name}" erstellt.', 'success')
    else:
        flash(f'Name "{name}" ist bereits vergeben.', 'error')
        
    return redirect(url_for('users_manager'))

@app.route('/create_clan', methods=['POST'])
@login_required
def create_clan():
    if not current_user.is_admin: return redirect(url_for('dashboard'))
    
    name = request.form.get('clan_name')
    # Für Admin-erstellte Clans setzen wir ein Standard-Passwort (oder leer, falls gewünscht)
    # Hier nehmen wir einfach "1234" als Platzhalter, Admins sollten Clans sagen, sie sollen es ändern
    # Oder du baust ein Passwort-Feld in das HTML ein (siehe users.html Anpassung unten)
    default_pw = "1234" 
    
    if Clan.query.filter_by(name=name).first():
        flash('Clan Name existiert bereits.', 'error')
    else:
        hashed_pw = generate_password_hash(default_pw, method='pbkdf2:sha256')
        new_clan = Clan(name=name, password=hashed_pw)
        db.session.add(new_clan)
        db.session.commit()
        flash(f'Clan "{name}" erstellt! (Standard-PW: 1234)', 'success')
        
    return redirect(url_for('users_manager'))

@app.route('/delete_clan/<int:clan_id>', methods=['POST'])
@login_required
def delete_clan(clan_id):
    if not current_user.is_admin: return redirect(url_for('dashboard'))
    clan = Clan.query.get_or_404(clan_id)
    
    # Optional: User aus dem Clan "befreien" statt zu löschen?
    # Hier löschen wir den Clan, die User werden dank backref oft auf NULL gesetzt 
    # oder bleiben erhalten (je nach DB Einstellung). Standardmäßig sicher.
    db.session.delete(clan)
    db.session.commit()
    flash(f'Clan "{clan.name}" gelöscht.', 'success')
    return redirect(url_for('users_manager'))

# delete_user bleibt gleich, leitet aber auf users_manager um
@app.route('/delete_user/<int:user_id>', methods=['POST'])
@login_required
def delete_user(user_id):
    if not current_user.is_admin: return redirect(url_for('dashboard'))
    u = User.query.get_or_404(user_id)
    if not u.is_admin:
        db.session.delete(u)
        db.session.commit()
        flash('Team gelöscht.', 'success')
    return redirect(url_for('users_manager'))